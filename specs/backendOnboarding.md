# Specification for: Backend AI Onboarding Service

This document outlines the required changes to the backend AI service to support the new hybrid, asynchronous conversational onboarding flow.

## 1. Guiding Principle: Reactive Personalization
The backend's role is no longer to drive the conversation but to *react* to user inputs with personalized, empathetic messages. It enriches the frontend-driven flow.

## 2. API Endpoint: `POST /api/v1/ai/onboarding`
The core endpoint remains the same, but its request and response payloads will be simplified.

### Revised Request Payload
The frontend will send the complete history of answers, allowing the AI to have full context for its empathetic response.

```json
{
  "session_id": "user-session-uuid",
  "step_id": "stressLevel", // The ID of the question the user just answered
  "user_answers": {
    "moneyGoal": "pay-faster",
    "stressLevel": 5
    // ... all answers collected so far
  }
}
```

### Revised Response Payload
The backend will now only return Clara's personalized message. The frontend is responsible for the next question.

```json
{
  "schema_version": "1.1", // Updated version
  "request_id": "request-uuid",
  "timestamp": "2025-11-28T...",
  "response": {
    "clara_message": "Thank you for sharing that. It's completely understandable to feel significant stress in this situation, and you've come to the right place for help.",
    "validation_error": null
  }
}
```
If validation is needed for complex cases (e.g., parsing natural language numbers), the `validation_error` field can be used.

## 3. AI Prompt Engineering (`backend/config/ai_prompts.yaml`)
We need a new prompt template specifically for generating these reactive, empathetic messages.

### New Prompt Template: `onboarding_reaction`

**System Prompt (Clara Persona):**
```yaml
You are Clara, an empathetic and supportive AI guide from Pathlight. Your role is to provide warm, encouraging, and brief (1-2 sentences) reactions to a user's answers during their onboarding. You are like a friendly coach, validating their feelings and encouraging them on their journey.

RULES:
- **DO NOT ASK QUESTIONS.** The frontend handles the questions.
- Keep your responses short, conversational, and chat-like.
- Your tone should always be warm, calm, guilt-free, and emotionally intelligent.
- Base your reaction on the user's most recent answer, using the full answer history for context.
- If you see a specific pattern (e.g., high stress, low income), use one of the specialized empathetic responses.
- If there's no specific pattern, provide a general, positive acknowledgment.
```

**User Prompt Template:**
```jinja2
The user is filling out their Pathlight profile. Here are their answers so far:
{{ user_answers | tojson }}

They just answered the '{{ step_id }}' question.

Based on their answers, provide a short, empathetic reaction.

---
**Specialized Empathetic Responses (Prioritize these if they match):**

{% if user_answers.stressLevel and user_answers.stressLevel >= 4 %}
- **High Stress:** Acknowledge their stress. Example: "Thanks for sharing that—I know talking about debt can be stressful. I’m here with you every step of the way."
{% endif %}

{% if user_answers.monthlyIncome and user_answers.monthlyExpenses and (user_answers.monthlyIncome - user_answers.monthlyExpenses < 0) %}
- **Negative Cash Flow:** Validate their situation. Example: "It's okay to be in a tight spot right now. You're taking the right first step by creating a plan."
{% endif %}

{% if user_answers.ageRange == '18-24' %}
- **Young User:** Encourage their proactivity. Example: "It's fantastic that you're building these healthy financial habits early on. It makes a huge difference."
{% endif %}

{% if user_answers.moneyGoal == 'pay-faster' %}
- **Pay Faster Goal:** Align with their goal. Example: "Great! We’ll focus on finding the fastest path forward for you."
{% endif %}

---
If none of the special cases match, provide a general encouraging reaction based on the last answer. For example, if they just chose their employment status, you could say: "Perfect, thanks for sharing. That context is really helpful."
```

## 4. Backend Logic (`backend/app/ai_services/routes.py`)

The `onboarding_conversation` function needs to be updated:

1.  **Input:** It will receive the `OnboardingReactionRequest` model (a new Pydantic model matching the revised request payload).
2.  **Processing:**
    *   Load the `onboarding_reaction` prompt.
    *   Pass the `user_answers` and `step_id` to the prompt template.
    *   Call the AI service (Gemini) with the rendered prompt.
3.  **Output:** Return an `OnboardingReactionResponse` containing the `clara_message` generated by the AI.

## 5. Developer Notes
*   Create new Pydantic models for `OnboardingReactionRequest` and `OnboardingReactionResponse` in `backend/app/shared/ai_models.py`.
*   This approach keeps the backend stateless, as the full context is provided in each request. This is simpler to implement and debug.
*   The Jinja2 templating in the prompt allows us to handle the personalization logic declaratively, keeping the Python code clean.

This backend specification provides a clear plan for adapting the AI service to the new, improved hybrid onboarding flow.