# Financial Health Assessment Module

## Overview

The Financial Health Assessment module produces a **Debt Composition Risk Score (0-100)**, structured financial interpretation, and personalized UX copy generated by an LLM using controlled prompts and backup UX language.

## Architecture

The system has three distinct layers:

### 1. Deterministic Calculation Layer
Pure mathematical computation with **no AI involvement**.

**Formula:**
```
Risk Score = (D × 50) + (H × 30) + (C × 20)
```

**Components:**
- **D (Delinquency Factor)**: `min(1.0, delinquent_count / total_debts)`
- **H (High-Rate Factor)**: `high_rate_balance / total_balance` (where high-rate = APR ≥ 20%)
- **C (Complexity Factor)**: `min(1.0, (debt_count - 3) / 7)`

**Output:**
```python
{
  "risk_score": 0-100,
  "risk_band": "excellent" | "low_moderate" | "moderate" | "high" | "critical",
  "debt_count": int,
  "primary_driver": "delinquency" | "high_rate" | "complexity",
  "drivers": {
    "delinquency_factor": 0.0-1.0,
    "high_rate_factor": 0.0-1.0,
    "complexity_factor": 0.0-1.0
  },
  "driver_severity": ["driver1", "driver2", "driver3"]  # sorted by weighted impact
}
```

### 2. Deterministic Financial Interpretation Layer
Rule-based interpretation with **no AI involvement**.

**Risk Bands:**
| Score | Band | Description |
|-------|------|-------------|
| 0-14 | excellent | Very low risk |
| 15-29 | low_moderate | Minor risk factors |
| 30-49 | moderate | Multiple emerging risks |
| 50-69 | high | High-cost or hard-to-manage debt |
| 70-100 | critical | Severe risk; likely financial strain |

**Output:**
```python
{
  "summary": "What the score means financially",
  "key_drivers": ["Ranked list of drivers with impact %"],
  "interpretation_points": [
    "Dynamic, data-grounded insights with actual numbers",
    "e.g., '66% of your debt carries rates ≥20% (2 accounts)'"
  ]
}
```

### 3. AI-Generated UX Copy Layer
LLM-generated personalized messaging using controlled prompts.

**Inputs:**
- Deterministic interpretation (from Layer 2)
- User context (goal, stress, employment, life events, age)
- Controlled prompt templates
- Backup UX copy snippets
- Guardrails

**Output:**
```python
{
  "user_friendly_summary": "2-3 sentence summary",
  "personalized_recommendations": ["3-5 actionable bullets"],
  "closing_message": "Encouraging, goal-aligned closing"
}
```

## Key Enhancements

### 1. Debt Count in Output
**Why:** LLMs produce more natural, human-centric coaching with raw quantities.

**Example:**
- ✅ With: "Managing 9 separate debts can feel overwhelming…"
- ❌ Without: "Your complexity factor is high…" (robotic)

### 2. Weighted Driver Sorting
**Why:** Sorts by actual score contribution (D×50, H×30, C×20), not just factor value.

**Example:**
- C = 0.9 → contributes 18 points
- H = 0.6 → contributes 18 points
- Both equally weighted, but H might be more actionable

### 3. Dynamic Interpretation Points
**Why:** Grounded, factual statements reduce hallucination risk.

**Example:**
- ✅ Dynamic: "About 70% of your total debt carries interest rates ≥20%, which adds significant monthly cost."
- ❌ Static: "High-rate debt is consuming cash flow."

### 4. Primary Driver Field
**Why:** Anchors summary and reduces LLM complexity.

**Benefit:** Ensures UX copy leads with the main issue for clarity.

## Usage

### Basic Usage

```python
from app.shared.financial_assessment import (
    DebtInput,
    UserContext,
    assess_financial_health
)

# Define debts
debts = [
    DebtInput(balance=10000, apr=24.99, is_delinquent=False),
    DebtInput(balance=5000, apr=21.5, is_delinquent=False),
    DebtInput(balance=3000, apr=8.5, is_delinquent=False)
]

# Define user context
user_context = UserContext(
    goal="reduce_stress",
    stress_level="high",
    employment_status="stable",
    life_events="baby",
    age_range="30_44"
)

# Run assessment
result = await assess_financial_health(
    debts=debts,
    user_context=user_context,
    ai_service=your_ai_service  # Optional, uses fallback if None
)

# Access results
print(f"Risk Score: {result.deterministic_output.risk_score}/100")
print(f"Risk Band: {result.deterministic_output.risk_band}")
print(f"Summary: {result.personalized_ux.user_friendly_summary}")
```

### Layer-by-Layer Usage

```python
from app.shared.financial_assessment import (
    DeterministicCalculator,
    FinancialInterpreter,
    UXCopyGenerator
)

# Layer 1: Calculate risk
risk_output = DeterministicCalculator.calculate(debts)

# Layer 2: Interpret results
interpretation = FinancialInterpreter.interpret(risk_output, debts)

# Layer 3: Generate UX copy
personalized_ux = await UXCopyGenerator.generate(
    risk_output,
    interpretation,
    user_context,
    ai_service
)
```

## Testing

Run the comprehensive test suite:

```bash
cd backend
python3 test_financial_assessment.py
```

**Test Coverage:**
- ✅ Excellent risk profile (score 0-14)
- ✅ High risk profile (score 50-69)
- ✅ Complexity-driven risk
- ✅ Edge cases (single debt, 10+ debts, all delinquent, etc.)
- ✅ Boundary conditions (19.9% vs 20% APR)
- ✅ Complete three-layer assessment

## Data Flow

```
1. User provides debt information
   ↓
2. Layer 1: Calculate D, H, C → risk_score, risk_band
   ↓
3. Layer 2: Generate financial interpretation with dynamic data
   ↓
4. Layer 3: Construct LLM prompt with:
   - Deterministic interpretation
   - User context
   - Backup UX copy
   ↓
5. LLM generates personalized UX text
   ↓
6. Display to user
```

## Benefits

### Accuracy
All math & interpretation is deterministic; LLM cannot drift from facts.

### Safety
Backup UX copy anchors the LLM and prevents hallucination.

### Scalability
Easily extend to new modules (Credit Score, Cash Flow, etc.).

### Personalization
LLM tailors tone and advice to goals, stress, life events.

### Brand Consistency
Controlled prompts ensure the same voice across experiences.

## Configuration

### Risk Thresholds
```python
HIGH_RATE_THRESHOLD = 20.0  # APR threshold for high-rate debt
COMPLEXITY_BASE = 3         # Baseline number of debts
COMPLEXITY_RANGE = 7        # Range for complexity calculation
```

### Risk Band Ranges
- Excellent: 0-14
- Low/Moderate: 15-29
- Moderate: 30-49
- High: 50-69
- Critical: 70-100

## API Integration

To integrate with your API routes:

```python
from app.shared.financial_assessment import assess_financial_health, DebtInput, UserContext

@router.post("/api/v1/financial-assessment")
async def get_financial_assessment(profile_id: str):
    # Fetch user's debts from database
    debts = await fetch_user_debts(profile_id)
    
    # Convert to DebtInput format
    debt_inputs = [
        DebtInput(
            balance=debt.balance,
            apr=debt.apr,
            is_delinquent=debt.is_delinquent
        )
        for debt in debts
    ]
    
    # Fetch user context
    user_context = await fetch_user_context(profile_id)
    
    # Run assessment
    result = await assess_financial_health(
        debts=debt_inputs,
        user_context=user_context,
        ai_service=get_ai_service()
    )
    
    return result
```

## Future Extensions

This architecture can be extended to additional financial health modules:

1. **Credit Score Impact Module**
   - Calculate credit utilization
   - Assess payment history impact
   - Predict score changes

2. **Cash Flow Health Module**
   - Income vs. debt payments
   - Emergency fund adequacy
   - Sustainability analysis

3. **Goal Progress Module**
   - Track toward debt-free date
   - Milestone achievements
   - Momentum indicators

Each module follows the same three-layer pattern for consistency and reliability.

## License

Part of the SnapDev Wise Okapi Flit project.